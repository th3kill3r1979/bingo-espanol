<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Cart√≥n - Bingo Espa√±ol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Force landscape orientation hint */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            body::before {
                content: "üì± Gira tu dispositivo para mejor experiencia";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #F59E0B, #EC4899);
                color: white;
                text-align: center;
                padding: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 9999;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.7;
                }
            }
        }

        /* Optimize card for landscape */
        @media screen and (orientation: landscape) {
            .card-container {
                max-width: 95vw;
                margin: 0 auto;
            }

            .card-grid {
                max-height: 70vh;
            }
        }

        /* Mobile landscape optimization */
        @media screen and (max-width: 896px) and (orientation: landscape) {
            body {
                padding-top: 0 !important;
            }

            .header-compact {
                padding: 0.5rem 0 !important;
                margin-bottom: 0.5rem !important;
            }

            .header-compact h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.25rem !important;
            }

            .header-compact p {
                font-size: 0.75rem !important;
            }

            .card-container {
                padding: 0.75rem !important;
                margin-bottom: 0.5rem !important;
            }

            .instructions-compact {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .style-selector {
                margin-bottom: 0.5rem !important;
            }
        }

        /* Tablet landscape */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .card-container {
                max-width: 90vw;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-2 sm:py-6 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-2 sm:mb-4 header-compact">
            <h1
                class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2 bg-gradient-to-r from-yellow-300 to-orange-400 bg-clip-text text-transparent">
                üé∞ Mi Cart√≥n de Bingo
            </h1>
            <p class="text-xs sm:text-sm text-gray-300">Toca los n√∫meros para marcarlos</p>
        </header>

        <!-- Game Status -->
        <div id="gameStatus" class="mb-4 text-center">
            <p class="text-xs text-gray-400">ID del Juego: <span id="gameId" class="font-mono text-yellow-400">-</span>
            </p>
        </div>

        <!-- Invalid Game Message -->
        <div id="invalidMessage" class="hidden mb-6 bg-red-500/20 border border-red-500 rounded-xl p-4 text-center">
            <p class="text-lg font-bold text-red-300">‚ö†Ô∏è Juego Reiniciado</p>
            <p class="text-sm text-gray-300 mt-2">Este cart√≥n ya no es v√°lido. Por favor, recarga la p√°gina para obtener
                un nuevo cart√≥n.</p>
            <button onclick="location.reload()"
                class="mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">
                Recargar P√°gina
            </button>
        </div>

        <!-- Style Selector -->
        <div class="mb-2 sm:mb-4 flex justify-center gap-2 style-selector">
            <button id="styleModern"
                class="style-btn px-3 sm:px-4 py-1.5 sm:py-2 text-sm sm:text-base rounded-lg font-semibold transition-all bg-purple-600 text-white">
                üé® Moderno
            </button>
            <button id="styleClassic"
                class="style-btn px-3 sm:px-4 py-1.5 sm:py-2 text-sm sm:text-base rounded-lg font-semibold transition-all bg-white/20 text-gray-300 hover:bg-white/30">
                üìã Cl√°sico
            </button>
        </div>

        <!-- Bingo Card -->
        <div id="bingoCardContainer"
            class="card-container bg-white/10 backdrop-blur-lg rounded-2xl p-3 sm:p-6 border border-white/20 shadow-2xl mb-2 sm:mb-6">
            <!-- Serial Number & Name -->
            <div class="mb-2 sm:mb-4 text-center">
                <div class="flex justify-between items-center px-4">
                    <div class="text-left">
                        <p class="text-xs text-gray-400">Jugador:</p>
                        <p id="playerNameDisplay" class="font-bold text-lg text-white truncate max-w-[150px]">-</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">Serie:</p>
                        <p id="serialNumber" class="font-mono text-xl sm:text-2xl font-bold text-yellow-400">-</p>
                    </div>
                </div>
            </div>

            <!-- Card Grid (3x9) -->
            <div id="bingoCard" class="card-grid space-y-1 sm:space-y-2">
                <!-- Card will be rendered here -->
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions-compact bg-white/10 backdrop-blur-lg rounded-xl p-3 sm:p-4 border border-white/20">
            <h3 class="font-bold mb-1 sm:mb-2 text-center text-sm sm:text-base">üìã Instrucciones</h3>
            <ul class="text-xs sm:text-sm text-gray-300 space-y-0.5 sm:space-y-1">
                <li>‚úì Toca un n√∫mero para colocar una ficha</li>
                <li>‚úì Toca una ficha para quitarla</li>
                <li>‚úì Los n√∫meros marcados se guardan autom√°ticamente</li>
                <li>‚úì Muestra este n√∫mero de serie al moderador para validar tu cart√≥n</li>
            </ul>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-white/30 border-t-yellow-400">
            </div>
            <p class="mt-4 text-gray-300">Cargando tu cart√≥n...</p>
        </div>

        <!-- Name Input Modal -->
        <div id="nameModal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div
                class="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-3xl p-8 max-w-md w-full border-2 border-purple-500 shadow-2xl transform animate-scale-in">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">üé∞</div>
                    <h2
                        class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-300 to-orange-400 bg-clip-text text-transparent">
                        ¬°Bienvenido!
                    </h2>
                    <p class="text-gray-300">Ingresa tu nombre para comenzar</p>
                </div>

                <form id="nameForm" class="space-y-4">
                    <div>
                        <input type="text" id="playerNameInput" placeholder="Tu nombre" required maxlength="20"
                            class="w-full px-4 py-3 bg-white/10 border-2 border-white/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 transition-all text-center text-lg font-semibold"
                            autocomplete="off">
                    </div>
                    <button type="submit"
                        class="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-gray-900 font-bold text-lg rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                        Obtener Mi Cart√≥n üé≤
                    </button>
                </form>

                <p class="text-xs text-gray-400 text-center mt-4">
                    Tu nombre aparecer√° cuando ganes
                </p>
            </div>
        </div>

        <style>
            @keyframes scale-in {
                from {
                    opacity: 0;
                    transform: scale(0.8);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .animate-scale-in {
                animation: scale-in 0.3s ease-out;
            }
        </style>
    </div>

    <script>
        const socket = io();
        let myCard = null;
        let currentGameId = '';
        let markedNumbers = new Set();
        let currentStyle = 'modern'; // 'modern' or 'classic'

        // DOM Elements
        const gameIdEl = document.getElementById('gameId');
        const serialNumberEl = document.getElementById('serialNumber');
        const bingoCardEl = document.getElementById('bingoCard');
        const bingoCardContainer = document.getElementById('bingoCardContainer');
        const loadingState = document.getElementById('loadingState');
        const invalidMessage = document.getElementById('invalidMessage');
        const styleModernBtn = document.getElementById('styleModern');
        const styleClassicBtn = document.getElementById('styleClassic');
        const nameModal = document.getElementById('nameModal');
        const nameForm = document.getElementById('nameForm');
        const playerNameInput = document.getElementById('playerNameInput');

        // Player Name Logic
        let playerName = sessionStorage.getItem('bingoPlayerName');

        // Initial setup
        loadingState.classList.add('hidden'); // Hide loading initially

        if (playerName) {
            // Already has name, connect immediately
            nameModal.classList.add('hidden');
            loadingState.classList.remove('hidden');
            connectAndRequestCard();
        } else {
            // Show name modal
            nameModal.classList.remove('hidden');
        }

        // Handle name submission
        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = playerNameInput.value.trim();
            if (name) {
                playerName = name;
                sessionStorage.setItem('bingoPlayerName', name);
                nameModal.classList.add('hidden');
                loadingState.classList.remove('hidden');
                connectAndRequestCard();
            }
        });

        function connectAndRequestCard() {
            if (socket.connected) {
                // Recover stored card info
                const savedSerial = localStorage.getItem('bingoSerialNumber');
                const savedGameId = localStorage.getItem('bingoGameId');

                socket.emit('request-card', {
                    playerName,
                    serialNumber: savedSerial,
                    gameId: savedGameId
                });
            } else {
                socket.connect();
            }
        }

        // Style selector
        styleModernBtn.addEventListener('click', () => {
            currentStyle = 'modern';
            updateStyleButtons();
            renderCard();
        });

        styleClassicBtn.addEventListener('click', () => {
            currentStyle = 'classic';
            updateStyleButtons();
            renderCard();
        });

        function updateStyleButtons() {
            if (currentStyle === 'modern') {
                styleModernBtn.className = 'style-btn px-4 py-2 rounded-lg font-semibold transition-all bg-purple-600 text-white';
                styleClassicBtn.className = 'style-btn px-4 py-2 rounded-lg font-semibold transition-all bg-white/20 text-gray-300 hover:bg-white/30';
            } else {
                styleModernBtn.className = 'style-btn px-4 py-2 rounded-lg font-semibold transition-all bg-white/20 text-gray-300 hover:bg-white/30';
                styleClassicBtn.className = 'style-btn px-4 py-2 rounded-lg font-semibold transition-all bg-purple-600 text-white';
            }
        }

        // Request a card when connected
        socket.on('connect', () => {
            if (playerName) {
                connectAndRequestCard();
            }
        });

        // Receive assigned card
        socket.on('card-assigned', (data) => {
            currentGameId = data.gameId;
            myCard = data.card;

            // Store card info for persistence
            localStorage.setItem('bingoSerialNumber', data.card.serialNumber);
            localStorage.setItem('bingoGameId', data.gameId);

            gameIdEl.textContent = data.gameId;
            serialNumberEl.textContent = data.card.serialNumber;

            // Set player name display
            const nameDisplay = document.getElementById('playerNameDisplay');
            if (nameDisplay) {
                nameDisplay.textContent = data.card.playerName || 'Jugador';
            }

            // Load marked numbers from sessionStorage
            loadMarkedNumbers();

            // Render the card
            renderCard();

            // Show card, hide loading
            loadingState.classList.add('hidden');
            bingoCardContainer.classList.remove('hidden');
        });

        // Game reset event
        socket.on('game-reset', (data) => {
            // Show invalid message if the game ID changed
            if (data.gameId !== currentGameId) {
                invalidMessage.classList.remove('hidden');
                bingoCardContainer.classList.add('opacity-50', 'pointer-events-none');
            }
        });

        // Render the bingo card
        function renderCard() {
            if (!myCard) return;

            bingoCardEl.innerHTML = '';

            if (currentStyle === 'modern') {
                renderModernCard();
            } else {
                renderClassicCard();
            }
        }

        // Modern style (original)
        function renderModernCard() {
            for (let row = 0; row < 3; row++) {
                const rowEl = document.createElement('div');
                rowEl.className = 'grid grid-cols-9 gap-1 sm:gap-2';

                for (let col = 0; col < 9; col++) {
                    const cellEl = document.createElement('div');
                    const number = myCard.matrix[row][col];

                    if (number === null) {
                        // Empty space
                        cellEl.className = 'aspect-square rounded-lg bg-gray-700/30 border border-gray-600/50';
                    } else {
                        // Number cell
                        const isMarked = markedNumbers.has(number);
                        cellEl.className = `aspect-square rounded-lg flex items-center justify-center font-bold text-base sm:text-xl cursor-pointer transition-all duration-200 active:scale-95 relative ${isMarked
                            ? 'bg-white/90 text-gray-900 shadow-lg'
                            : 'bg-white/20 text-white border-2 border-white/40 hover:bg-white/30'
                            }`;

                        // Number text
                        const numberSpan = document.createElement('span');
                        numberSpan.textContent = number;
                        numberSpan.className = 'relative z-10';
                        cellEl.appendChild(numberSpan);

                        // Chip overlay (if marked)
                        if (isMarked) {
                            const chip = document.createElement('div');
                            chip.className = 'absolute inset-0 bg-gradient-to-br from-red-500/70 to-orange-500/70 rounded-lg backdrop-blur-sm';
                            cellEl.insertBefore(chip, numberSpan);
                        }

                        // Click handler
                        cellEl.addEventListener('click', () => toggleNumber(number));
                    }

                    rowEl.appendChild(cellEl);
                }

                bingoCardEl.appendChild(rowEl);
            }
        }

        // Classic style (inspired by traditional bingo cards)
        function renderClassicCard() {
            // Create classic bingo card container
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'bg-white rounded-xl p-2 sm:p-4 shadow-2xl';

            // Add "BINGO" header
            const header = document.createElement('div');
            header.className = 'text-center mb-2 sm:mb-3';
            header.innerHTML = '<h2 class="text-2xl sm:text-3xl font-black text-gray-800 tracking-widest">BINGO</h2>';
            cardWrapper.appendChild(header);

            // Create table
            const table = document.createElement('table');
            table.className = 'w-full border-collapse';

            for (let row = 0; row < 3; row++) {
                const rowEl = document.createElement('tr');

                for (let col = 0; col < 9; col++) {
                    const cellEl = document.createElement('td');
                    const number = myCard.matrix[row][col];

                    if (number === null) {
                        // Empty space
                        cellEl.className = 'border-2 border-gray-400 bg-gray-200 aspect-square p-1 sm:p-2';
                        cellEl.style.width = '11.11%';
                    } else {
                        // Number cell
                        const isMarked = markedNumbers.has(number);
                        cellEl.className = `border-2 border-gray-800 bg-white text-center cursor-pointer transition-all active:scale-95 relative ${isMarked ? 'bg-red-100' : 'hover:bg-yellow-50'}`;
                        cellEl.style.width = '11.11%';

                        // Number text
                        const numberSpan = document.createElement('span');
                        numberSpan.textContent = number;
                        numberSpan.className = `block text-lg sm:text-2xl font-bold relative z-10 py-2 sm:py-3 ${isMarked ? 'text-white' : 'text-gray-900'}`;
                        cellEl.appendChild(numberSpan);

                        // Classic chip overlay (if marked)
                        if (isMarked) {
                            const chip = document.createElement('div');
                            chip.className = 'absolute inset-0 flex items-center justify-center';
                            chip.innerHTML = '<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-red-600 border-4 border-red-800 shadow-lg"></div>';
                            cellEl.insertBefore(chip, numberSpan);
                        }

                        // Click handler
                        cellEl.addEventListener('click', () => toggleNumber(number));
                    }

                    rowEl.appendChild(cellEl);
                }

                table.appendChild(rowEl);
            }

            cardWrapper.appendChild(table);
            bingoCardEl.appendChild(cardWrapper);
        }

        // Toggle number marking
        function toggleNumber(number) {
            if (markedNumbers.has(number)) {
                markedNumbers.delete(number);
            } else {
                markedNumbers.add(number);
            }

            saveMarkedNumbers();
            renderCard();
        }

        // Save marked numbers to sessionStorage
        function saveMarkedNumbers() {
            if (!myCard) return;
            const key = `marked_${myCard.serialNumber}`;
            sessionStorage.setItem(key, JSON.stringify([...markedNumbers]));
        }

        // Load marked numbers from sessionStorage
        function loadMarkedNumbers() {
            if (!myCard) return;
            const key = `marked_${myCard.serialNumber}`;
            const saved = sessionStorage.getItem(key);

            if (saved) {
                try {
                    const numbers = JSON.parse(saved);
                    markedNumbers = new Set(numbers);
                } catch (e) {
                    markedNumbers = new Set();
                }
            } else {
                markedNumbers = new Set();
            }
        }

        // Initialize
        bingoCardContainer.classList.add('hidden');
    </script>
</body>

</html>