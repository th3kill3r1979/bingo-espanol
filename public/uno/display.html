<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero UNO - Premium</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üÉè</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
            overflow: hidden;
        }

        .uno-card {
            aspect-ratio: 2/3;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border: 6px solid white;
            position: relative;
            transform: rotate(-5deg);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: #000;
            overflow: hidden;
        }

        .uno-card.red {
            background: #ff5555;
        }

        .uno-card.blue {
            background: #5555ff;
        }

        .uno-card.green {
            background: #55aa55;
        }

        .uno-card.yellow {
            background: #ffaa00;
        }

        .uno-card.wild {
            background: #222;
        }

        .card-inner {
            position: absolute;
            width: 140%;
            height: 90%;
            background: white;
            border-radius: 50%;
            transform: rotate(25deg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .card-symbol {
            font-size: 5rem;
            color: inherit;
            /* Parent color will be applied via JS */
            z-index: 2;
            transform: rotate(-25deg);
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.2));
        }

        .card-corner {
            position: absolute;
            font-size: 1.2rem;
            color: white;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .corner-top {
            top: 8px;
            left: 8px;
        }

        .corner-bottom {
            bottom: 8px;
            right: 8px;
            transform: rotate(180deg);
        }

        .player-hand {
            transition: all 0.3s ease;
        }

        .active-player {
            border: 4px solid #facc15;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.5);
            transform: scale(1.05);
        }

        .wild-color-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotate(-5deg);
            }

            50% {
                transform: translateY(-20px) rotate(5deg);
            }

            100% {
                transform: translateY(0px) rotate(-5deg);
            }
        }

        .floating {
            animation: float 4s ease-in-out infinite;
        }

        .qr-placeholder {
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }

        .disconnected-player {
            opacity: 0.5;
            filter: grayscale(70%);
        }

        .kick-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .kick-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .disconnected-label {
            background: #6b7280;
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Draw Stack Indicator */
        .draw-stack-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 20px;
            padding: 20px 30px;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.6);
            z-index: 10;
            animation: pulse 2s infinite;
        }

        .draw-stack-counter {
            font-size: 4rem;
            font-weight: 900;
            color: white;
            text-align: center;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Chat Panel */
        .chat-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            max-height: 400px;
        }

        .chat-display h3 {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        #displayChatMessages {
            max-height: 300px;
            overflow-y: auto;
            font-size: 11px;
            scrollbar-width: thin;
        }

        .display-chat-message {
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            line-height: 1.4;
        }
    </style>
</head>

<body class="min-h-screen text-white p-8">
    <div class="fixed top-8 left-8 z-50">
        <a href="/"
            class="bg-white/10 hover:bg-white/20 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/20 transition-all flex items-center gap-3 shadow-lg group">
            <i class="fas fa-home text-white group-hover:scale-110 text-xl"></i>
            <span class="font-bold uppercase tracking-widest hidden md:inline">Inicio</span>
        </a>
    </div>

    <div class="max-w-7xl mx-auto h-full flex flex-col">
        <!-- Header -->
        <header class="flex justify-between items-center mb-12">
            <h1
                class="text-5xl font-black tracking-tighter bg-gradient-to-r from-red-500 via-yellow-400 to-green-500 bg-clip-text text-transparent">
                UNO DIGITAL PREMIUM
            </h1>
            <div id="gameStatus"
                class="bg-white/10 backdrop-blur-md px-6 py-2 rounded-full border border-white/20 font-bold uppercase tracking-widest text-sm">
                Esperando jugadores...
            </div>
        </header>

        <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Players List -->
            <div class="lg:col-span-1 space-y-4">
                <h2 class="text-xl font-bold text-gray-400 uppercase tracking-widest mb-4">Jugadores</h2>
                <div id="playersList" class="space-y-3">
                    <!-- Players injected here -->
                    <p class="text-gray-500 italic">Nadie en la sala a√∫n...</p>
                </div>

                <div class="mt-8 p-6 bg-white/5 rounded-2xl border border-white/10">
                    <p class="text-xs text-gray-400 mb-2 uppercase font-bold">Instrucciones</p>
                    <p class="text-sm text-gray-300">Escanea el QR o entra a <span
                            class="text-yellow-400">/unoplayer</span> para unirte.</p>
                    <button id="startGameBtn"
                        class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-black py-3 rounded-xl transition-all uppercase tracking-tighter shadow-lg">
                        Comenzar Juego
                    </button>
                    <button id="restartRndBtn"
                        class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition-all uppercase tracking-tighter shadow-lg hidden">
                        Reiniciar Ronda
                    </button>
                </div>

                <!-- Chat Display -->
                <div class="chat-display mt-6">
                    <h3>üí¨ Chat</h3>
                    <div id="displayChatMessages"></div>
                </div>
            </div>

            <!-- Central Game Area -->
            <div class="lg:col-span-2 flex flex-col items-center justify-center relative">
                <div id="deckArea" class="mb-12 flex items-center gap-12">
                    <!-- Discard Pile -->
                    <div class="flex flex-col items-center">
                        <p class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Pozo</p>
                        <div id="topCardContainer" class="w-48 floating">
                            <div class="uno-card wild w-48 h-72">
                                <div class="card-inner text-2xl font-black opacity-20">UNO</div>
                            </div>
                        </div>
                    </div>

                    <!-- Draw Pile (Visual only) -->
                    <div class="flex flex-col items-center opacity-50">
                        <p class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Mazo</p>
                        <div
                            class="w-48 h-72 bg-gradient-to-br from-gray-700 to-black rounded-2xl border-4 border-white flex items-center justify-center transform rotate-3">
                            <span class="text-4xl font-black text-white/20 uppercase transform -rotate-45">UNO</span>
                        </div>
                    </div>
                </div>

                <!-- Wild Color Indicator -->
                <div id="wildColorArea" class="hidden absolute top-0 right-0 flex flex-col items-center">
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Color Elegido</p>
                    <div id="wildColorIndicator" class="wild-color-indicator"></div>
                </div>

                <div id="turnIndicator"
                    class="text-3xl font-black text-yellow-400 uppercase tracking-tighter animate-pulse hidden">
                    Turno de: <span id="currentPlayerName">-</span>
                </div>

                <!-- Draw Stack Display -->
                <div id="drawStackDisplay" class="hidden draw-stack-display">
                    <div class="draw-stack-counter">
                        +<span id="drawStackValue">0</span>
                    </div>
                    <p class="text-sm text-white text-center font-bold mt-2">Cartas acumuladas</p>
                </div>
            </div>

            <!-- QR & Stats -->
            <div class="lg:col-span-1 flex flex-col justify-between">
                <div
                    class="bg-white rounded-3xl p-6 shadow-2xl min-h-[300px] flex flex-col items-center justify-center">
                    <div id="qrLoading" class="qr-placeholder w-full aspect-square rounded-xl">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                            <p>GENERANDO QR...</p>
                        </div>
                    </div>
                    <img id="qrCode" src="" alt="QR Code" class="w-full hidden">
                    <p class="text-center text-xs text-gray-900 font-bold mt-4 uppercase">Escanea para jugar</p>
                </div>

                <div id="celebrationOverlay"
                    class="hidden mt-8 p-8 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-3xl text-center shadow-2xl animate-bounce">
                    <h2 class="text-4xl font-black text-white mb-2 italic">¬°GANADOR!</h2>
                    <p id="winnerName" class="text-2xl font-bold text-gray-900 uppercase">Nombre</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io({ transports: ['websocket'] });

        // DOM Elements
        const playersList = document.getElementById('playersList');
        const gameStatus = document.getElementById('gameStatus');
        const topCardContainer = document.getElementById('topCardContainer');
        const currentPlayerName = document.getElementById('currentPlayerName');
        const turnIndicator = document.getElementById('turnIndicator');
        const startGameBtn = document.getElementById('startGameBtn');
        const wildColorArea = document.getElementById('wildColorArea');
        const wildColorIndicator = document.getElementById('wildColorIndicator');
        const celebrationOverlay = document.getElementById('celebrationOverlay');
        const winnerNameEl = document.getElementById('winnerName');
        const restartRndBtn = document.getElementById('restartRndBtn');

        // Initial state
        socket.emit('uno-state-request'); // Future proofing

        socket.on('uno-state-update', (state) => {
            updatePlayers(state.players, state.currentPlayer);
            updateStatus(state.status);
            if (state.topCard) updateTopCard(state.topCard);
            if (state.qrCodeUrl) {
                const qrImg = document.getElementById('qrCode');
                const qrLoading = document.getElementById('qrLoading');
                qrImg.src = state.qrCodeUrl;
                qrImg.classList.remove('hidden');
                qrLoading.classList.add('hidden');
            }

            if (state.currentPlayer) {
                currentPlayerName.textContent = state.currentPlayer;
                turnIndicator.classList.remove('hidden');
            }

            if (state.wildColor) {
                wildColorArea.classList.remove('hidden');
                wildColorIndicator.style.backgroundColor = state.wildColor;
            } else {
                wildColorArea.classList.add('hidden');
            }

            // Update draw stack display
            const drawStackDisplay = document.getElementById('drawStackDisplay');
            const drawStackValue = document.getElementById('drawStackValue');
            if (state.drawStack > 0) {
                drawStackDisplay.classList.remove('hidden');
                drawStackValue.textContent = state.drawStack;
            } else {
                drawStackDisplay.classList.add('hidden');
            }

            // Update chat (keep last 15 messages)
            if (state.chatMessages && state.chatMessages.length > 0) {
                updateChatDisplay(state.chatMessages);
            }
        });

        socket.on('uno-game-over', (data) => {
            celebrationOverlay.classList.remove('hidden');
            winnerNameEl.textContent = data.winner;
            gameStatus.textContent = 'Juego Terminado';
        });

        startGameBtn.addEventListener('click', () => {
            socket.emit('uno-start');
        });

        restartRndBtn.addEventListener('click', () => {
            if (confirm('¬øReiniciar la ronda actual? Se mantendr√°n los jugadores pero se repartir√°n cartas nuevas.')) {
                socket.emit('uno-start');
            }
        });

        function updatePlayers(players, currentPlayerName) {
            playersList.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                const isDisconnected = p.connected === false;
                const disconnectedClass = isDisconnected ? 'disconnected-player' : '';
                const activeClass = p.name === currentPlayerName && !isDisconnected ? 'active-player bg-white/20' : 'bg-white/5 border border-white/10';

                div.className = `p-4 rounded-2xl flex justify-between items-center gap-3 transition-all ${activeClass} ${disconnectedClass}`;

                let statusBadge;
                if (isDisconnected) {
                    const timeAgo = getTimeAgo(p.lastSeen);
                    statusBadge = `<span class="disconnected-label">Desconectado (${timeAgo})</span>`;
                } else {
                    statusBadge = `<span class="bg-yellow-500 text-gray-900 px-3 py-1 rounded-full text-xs font-black shadow-lg">${p.cardCount} cartas</span>`;
                }

                div.innerHTML = `
                    <span class="font-bold flex-1">${p.name}</span>
                    ${statusBadge}
                    <button class="kick-btn" onclick="kickPlayer('${p.id}', '${p.name}')" title="Expulsar jugador">
                        üö´ KICK
                    </button>
                `;
                playersList.appendChild(div);
            });
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return '?';
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m`;
            return `${Math.floor(minutes / 60)}h`;
        }

        function updateTopCard(card) {
            const symbol = getCardSymbol(card.value);
            const colorClass = card.color === 'wild' ? 'text-gray-900' : `text-${card.color}-500`; // Dynamic color for symbol

            // Map card colors to CSS hex or tailwind equivalent for the symbol
            const colorMap = {
                red: '#ff5555',
                blue: '#5555ff',
                green: '#55aa55',
                yellow: '#ffaa00',
                wild: '#000000'
            };

            const cardColor = colorMap[card.color];

            topCardContainer.innerHTML = `
                <div class="uno-card ${card.color} w-48 h-72">
                    <div class="card-corner corner-top">
                        <span class="text-lg font-bold">${symbol}</span>
                    </div>
                    <div class="card-inner">
                        <div class="card-symbol" style="color: ${cardColor}">
                            ${symbol}
                        </div>
                    </div>
                    <div class="card-corner corner-bottom">
                        <span class="text-lg font-bold">${symbol}</span>
                    </div>
                </div>
            `;
        }

        function getCardSymbol(value) {
            if (value === 'Skip') return '<i class="fas fa-ban"></i>';
            if (value === 'Reverse') return '<i class="fas fa-sync"></i>';
            if (value === '+2') return '+2';
            if (value === '+4') return '+4';
            if (value === 'Wild') return '<i class="fas fa-palette"></i>';
            return value;
        }

        function updateStatus(status) {
            if (status === 'playing') {
                gameStatus.textContent = 'üü¢ Partida en curso';
                gameStatus.classList.add('text-green-400');
                startGameBtn.classList.add('hidden');
                restartRndBtn.classList.remove('hidden');
            } else if (status === 'waiting') {
                gameStatus.textContent = 'üü° Esperando jugadores';
                gameStatus.classList.remove('text-green-400');
                startGameBtn.classList.remove('hidden');
                restartRndBtn.classList.add('hidden');
            }
        }

        function kickPlayer(playerId, playerName) {
            if (confirm(`¬øEst√°s seguro de expulsar a ${playerName}?`)) {
                socket.emit('uno-kick-player', { playerId });
            }
        }

        // Chat functionality
        const displayChatMessages = document.getElementById('displayChatMessages');

        function updateChatDisplay(messages) {
            displayChatMessages.innerHTML = '';
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'display-chat-message';
                msgDiv.innerHTML = `<strong>${msg.playerName}:</strong> ${msg.text}`;
                displayChatMessages.appendChild(msgDiv);
            });
            displayChatMessages.scrollTop = displayChatMessages.scrollHeight;
        }

        socket.on('uno-chat-update', (message) => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'display-chat-message';
            msgDiv.innerHTML = `<strong>${message.playerName}:</strong> ${message.text}`;
            displayChatMessages.appendChild(msgDiv);
            displayChatMessages.scrollTop = displayChatMessages.scrollHeight;
        });
    </script>
</body>

</html>
```